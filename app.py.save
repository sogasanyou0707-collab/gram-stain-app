import streamlit as st
import google.generativeai as genai
import os
import random
from PIL import Image

# === è¨­å®šã‚¨ãƒªã‚¢ ===
# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã®ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆã“ã“ã‚’ã‚ãªãŸã®ãƒ•ã‚©ãƒ«ãƒ€åã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰
LIBRARY_FOLDER_NAME = 'test_library' 

st.title("ğŸ”¬ ã‚°ãƒ©ãƒ æŸ“è‰² AIç›¸è«‡ã‚¢ãƒ—ãƒª")
st.write("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€GeminiãŒè§£èª¬ã—ã€è¿‘ã„ç—‡ä¾‹ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚")

# APIã‚­ãƒ¼ã®å…¥åŠ›æ¬„
api_key = st.text_input("Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")

if api_key:
    # Geminiã®è¨­å®š
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-1.5-flash')

    # ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    uploaded_file = st.file_uploader("é¡•å¾®é¡å†™çœŸã‚’é¸æŠ...", type=["jpg", "png", "jpeg"])

    if uploaded_file is not None:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”»åƒã‚’è¡¨ç¤º
        image = Image.open(uploaded_file)
        st.image(image, caption='ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ', use_container_width=True)

        if st.button("AIã§è§£æã™ã‚‹"):
            with st.spinner('GeminiãŒæ€è€ƒä¸­...'):
                try:
                    # 1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã«ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆèŒç¨®ãƒªã‚¹ãƒˆï¼‰ã‚’å–å¾—
                    if os.path.exists(LIBRARY_FOLDER_NAME):
                        categories = [f for f in os.listdir(LIBRARY_FOLDER_NAME) if not f.startswith('.')]
                        categories_str = ", ".join(categories)
                    else:
                        categories = []
                        categories_str = "ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰"
                        st.warning(f"ãƒ•ã‚©ãƒ«ãƒ€ '{LIBRARY_FOLDER_NAME}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ«ãƒ€åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

                    # 2. Geminiã¸ã®å‘½ä»¤ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ä½œæˆ
                    prompt = f"""
                    ã‚ãªãŸã¯è‡¨åºŠå¾®ç”Ÿç‰©å­¦ã®å°‚é–€å®¶ã§ã™ã€‚ã“ã®ã‚°ãƒ©ãƒ æŸ“è‰²ç”»åƒã‚’è§£èª¬ã—ã¦ãã ã•ã„ã€‚
                    
                    ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
                    1. æ‰€è¦‹ï¼ˆæŸ“è‰²æ€§ã€å½¢æ…‹ã€é…åˆ—ãªã©ï¼‰
                    2. æ¨å®šã•ã‚Œã‚‹èŒç¨®ã‚°ãƒ«ãƒ¼ãƒ—
                    3. ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã®ä¸­ã§ã€æœ€ã‚‚è¿‘ã„ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Œã°1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚
                       ãƒªã‚¹ãƒˆ: [{categories_str}]
                       
                    ã€é‡è¦ã€‘
                    æœ€å¾Œã«å¿…ãšã€ŒCATEGORY:é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªåã€ã¨ã„ã†å½¢å¼ã§1è¡Œã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
                    è©²å½“ãªã—ã®å ´åˆã¯ã€ŒCATEGORY:Noneã€ã¨ã—ã¦ãã ã•ã„ã€‚
                    """

                    # 3. ç”»åƒã¨å‘½ä»¤ã‚’é€ä¿¡
                    response = model.generate_content([prompt, image])
                    text = response.text
                    
                    # 4. çµæœã®è¡¨ç¤º
                    st.markdown("### ğŸ¤– AIã®è§£æçµæœ")
                    st.write(text.replace("CATEGORY:", "")) # ã‚«ãƒ†ã‚´ãƒªè¡Œã¯
